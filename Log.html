<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat칩rio de Presen칞a - ADMIN</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
<style>
    /* Estilos globais e cores */
    :root {
        --primary-color: #901090;
        --bg-color-main: #c1c1c1;
        --bg-color-wrapper: black;
    }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-color-main); 
        padding: 20px;
        text-align: center;
    }
    .container {
        max-width: 1000px;
        margin: 20px auto;
        background: var(--bg-color-wrapper);
        padding: 25px; 
        border-radius: 12px; 
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5); 
        color: white;
    }
    h1 {
        color: var(--primary-color); 
        font-weight: 600;
        margin-bottom: 5px;
    }
    h2 {
        color: white;
        margin-bottom: 20px;
    }
    p {
        color: #cccccc;
    }
    
    /* --- Estilos da Tabela e Filtro --- */
    #searchArea, #loginForm {
        margin-bottom: 20px;
    }
    #searchInput, input[type="text"], input[type="password"] {
        padding: 10px;
        border: 1px solid #444;
        border-radius: 4px;
        margin-right: 10px;
        width: 100%;
        max-width: 300px;
        box-sizing: border-box;
        background-color: #333;
        color: white;
    }
    #searchArea #searchInput {
        max-width: 400px;
        margin-right: 0;
    }
    .admin-button {
        padding: 10px 15px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
        margin-left: 10px;
    }
    .admin-button:hover {
        background-color: #ff00ff;
    }

    /* Tabela */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: #333;
        color: white;
        display: none; /* Escondido por padr칚o */
    }
    th, td {
        border: 1px solid #444;
        padding: 12px 8px;
        text-align: left;
    }
    th {
        background-color: var(--primary-color);
        color: white;
        font-weight: 700;
        position: sticky;
        top: 0;
    }
    
    /* Mensagens */
    #loadingMessage, #errorMessage, #loginMessage {
        margin-top: 20px;
        font-weight: bold;
    }
    #loadingMessage {
        color: #ff00ff;
    }
    #errorMessage, #loginMessage {
        color: #dc3545;
    }

    /* Login Espec칤fico */
    #loginForm {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    #loginForm input {
        max-width: 350px;
    }
    #loginForm button {
        width: 100%;
        max-width: 350px;
    }

</style>
</head>
<body>
    <h1>游늶 Relat칩rio de Presen칞a - ADMIN</h1>

    <div id="loginSection" class="container">
        <h2>Acesso Administrativo</h2>
        <div id="loginForm">
            <input type="text" id="adminCpfInput" placeholder="CPF do Administrador" maxlength="14" required>
            <input type="password" id="adminKeyInput" placeholder="Chave Secreta Admin" required>
            <button class="admin-button" onclick="adminLogin()">Acessar Relat칩rio</button>
        </div>
        <p id="loginMessage"></p>
        <a href="index.html" style="color: #ccc; margin-top: 15px; display: block;">Voltar para o Login do Aluno</a>
    </div>

    <div id="reportSection" class="container" style="display: none;">
        <div id="searchArea">
            <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Filtrar por nome ou CPF...">
            <button class="admin-button" onclick="loadReportData()">Atualizar</button>
        </div>
        
        <p id="loadingMessage" style="display: none;">Carregando dados...</p>
        <p id="errorMessage"></p>

        <table>
            <thead>
                <tr>
                    <th>Nome do Aluno</th>
                    <th>CPF</th>
                    <th>Data</th>
                    <th>Hora</th>
                </tr>
            </thead>
            <tbody id="presencaData">
                </tbody>
        </table>
    </div>

    <script src="script.js"></script>
    <script>
        // Use a URL do Apps Script do script.js
        const SHEETDB_API_URL = 'https://script.google.com/macros/s/AKfycbyZkAwC19qf7Lu5vT3lhS7QN03KJcr4weoU6NYLbbzcD17bbLiAh3C51vXoPvISeR40/exec'; // **MANTENHA A URL REAL**
        const ADMIN_ACCESS_KEY = 'admin_access_granted';
        const ADMIN_CPF_KEY = 'admin_user_cpf';
        const ADMIN_KEY_VALUE = 'admin_key_value'; // Chave Admin real
        
        // Verifica se o admin j치 est치 logado
        if (localStorage.getItem(ADMIN_ACCESS_KEY) === 'true') {
            showReportSection();
            loadReportData();
        }

        function formatCPF(cpf) {
            // Re-implementa a fun칞칚o de formata칞칚o de CPF
            cpf = cpf.replace(/\D/g, '');
            cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
            cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
            cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            return cpf;
        }

        document.getElementById('adminCpfInput').addEventListener('input', (e) => {
            e.target.value = formatCPF(e.target.value);
        });

        function showReportSection() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('reportSection').style.display = 'block';
        }

        async function adminLogin() {
            const cpfInput = document.getElementById('adminCpfInput');
            const keyInput = document.getElementById('adminKeyInput');
            const messageElement = document.getElementById('loginMessage');
            
            const cpf = cpfInput.value.replace(/\D/g, '');
            const key = keyInput.value.trim();

            messageElement.textContent = '';
            if (cpf.length !== 11 || !key) {
                messageElement.textContent = 'Preencha o CPF e a Chave Admin.';
                return;
            }

            // Simula o login enviando credenciais para o Apps Script
            const searchUrl = `${SHEETDB_API_URL}?action=get_log_presenca&admin_cpf=${cpf}&admin_key=${key}`;
            
            messageElement.textContent = 'Verificando credenciais...';

            try {
                const response = await fetch(searchUrl);
                const result = await response.json();

                if (result.success) {
                    localStorage.setItem(ADMIN_ACCESS_KEY, 'true');
                    localStorage.setItem(ADMIN_CPF_KEY, cpf);
                    localStorage.setItem(ADMIN_KEY_VALUE, key);
                    
                    showReportSection();
                    renderReportTable(result.data);
                    messageElement.textContent = '';
                } else {
                    messageElement.textContent = result.message || 'Erro de autentica칞칚o. Chave ou CPF incorretos.';
                }
            } catch (error) {
                console.error("Erro no login admin:", error);
                messageElement.textContent = 'Erro de comunica칞칚o com o servidor.';
            }
        }

        async function loadReportData() {
            const cpf = localStorage.getItem(ADMIN_CPF_KEY);
            const key = localStorage.getItem(ADMIN_KEY_VALUE);
            
            const loading = document.getElementById('loadingMessage');
            const errorElement = document.getElementById('errorMessage');
            const table = document.querySelector('#reportSection table');
            const tbody = document.getElementById('presencaData');

            errorElement.textContent = '';
            tbody.innerHTML = '';
            table.style.display = 'none';
            loading.style.display = 'block';

            if (!cpf || !key) {
                localStorage.removeItem(ADMIN_ACCESS_KEY);
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('reportSection').style.display = 'none';
                return;
            }

            const fetchUrl = `${SHEETDB_API_URL}?action=get_log_presenca&admin_cpf=${cpf}&admin_key=${key}`;

            try {
                const response = await fetch(fetchUrl);
                const result = await response.json();

                if (result.success && result.data) {
                    renderReportTable(result.data);
                } else if (!result.success && result.message === 'Acesso negado. CPF ou Chave Admin incorreta.') {
                    // Se a chave/CPF foi revogado no servidor
                    localStorage.removeItem(ADMIN_ACCESS_KEY);
                    window.location.reload(); 
                } else {
                    throw new Error(result.message || 'Dados vazios ou formato inesperado.');
                }
            } catch (error) {
                console.error("Erro ao carregar relat칩rio:", error);
                errorElement.textContent = `Erro ao carregar relat칩rio. Detalhes: ${error.message}`;
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderReportTable(data) {
            const tbody = document.getElementById('presencaData');
            const table = document.querySelector('#reportSection table');
            tbody.innerHTML = '';
            
            // Reverte a ordem para mostrar o mais recente primeiro, se o Apps Script n칚o o fez
            // O Apps Script j치 est치 retornando invertido (mais recente primeiro)

            data.forEach(record => {
                const row = tbody.insertRow();
                
                // O Apps Script retorna data_registro como string ISO (Ex: 2025-12-03T13:36:34.000Z)
                const dateObj = new Date(record.data_registro);
                
                // Formata para a hora local
                const dataFormatada = dateObj.toLocaleDateString('pt-BR');
                const horaFormatada = dateObj.toLocaleTimeString('pt-BR', { hour12: false });
                
                // Constr칩i o atributo de busca para o filtro
                const searchData = `${record.nome_aluno || ''} ${record.cpf || ''}`.toLowerCase();
                row.setAttribute('data-search', searchData);

                row.insertCell().textContent = record.nome_aluno || 'N/A';
                row.insertCell().textContent = formatCPF(record.cpf || 'N/A');
                row.insertCell().textContent = dataFormatada;
                row.insertCell().textContent = horaFormatada;
            });

            table.style.display = 'table';
            document.getElementById('searchInput').value = '';
        }


        /**
         * Filtra a tabela em tempo real com base no texto digitado.
         */
        function filterTable() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            
            const tbody = document.getElementById('presencaData');
            const tr = tbody.getElementsByTagName('tr');

            for (let i = 0; i < tr.length; i++) {
                const row = tr[i];
                const searchData = row.getAttribute('data-search'); 

                if (searchData) {
                    if (searchData.indexOf(filter) > -1) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            }
        }
        
        // Adiciona a formata칞칚o de CPF ao campo de login Admin
        document.getElementById('adminCpfInput').addEventListener('input', (e) => {
            e.target.value = formatCPF(e.target.value);
        });

    </script>
</body>
</html>
