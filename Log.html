<!DOCTYPE html>
<html lang="pt-BR">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>Relatรณrio de Presenรงa - ADMIN</title>
	<link rel="icon" type="image/x-icon" href="favicon.ico">
<style>
ย ย body {
ย ย ย ย font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
ย ย ย ย background-color: #e9ecef; /* Cinza claro suave e moderno */
ย ย ย ย padding: 20px;
ย ย ย ย text-align: center;
ย ย }
ย ย .container {
ย ย ย ย max-width: 1000px;
ย ย ย ย margin: 20px auto;
ย ย ย ย background: #1c1c1c; /* Preto suave para tema escuro */
ย ย ย ย padding: 25px;
ย ย ย ย border-radius: 12px;
ย ย ย ย box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4); /* Sombra mais dramรกtica */
ย ย ย ย display: none;ย
ย ย }
ย ย h1 {
ย ย ย ย color: #901090; /* Mantendo o magenta de destaque */
ย ย ย ย font-weight: 700; /* Mais peso */
ย ย ย ย margin-bottom: 5px;
ย ย }
ย ย p {
ย ย ย ย color: #cccccc; /* Cinza claro para legibilidade no fundo escuro */
ย ย }
ย ย /* Estilo da barra de busca */
    #searchInput {
        padding: 10px; 
        width: 300px; 
        font-size: 16px;
        background-color: #333; /* Fundo escuro */
        color: #fff; /* Texto claro */
        border: 1px solid #901090 !important; /* Borda de destaque */
        border-radius: 4px; 
        transition: border-color 0.3s;
    }
    #searchInput:focus {
        border-color: #ff33aa !important; /* Borda mais clara ao focar */
        outline: none;
    }
ย ย /* --- Estilos da Tabela Melhorados --- */
ย ย table {
ย ย ย ย width: 100%;
ย ย ย ย border-collapse: collapse;
ย ย ย ย margin-top: 25px;
ย ย ย ย border-radius: 8px;
ย ย ย ย overflow: hidden;
ย ย }
ย ย th, td {
ย ย ย ย border: none;
ย ย ย ย padding: 15px 12px;
ย ย ย ย text-align: left;
ย ย ย ย font-size: 15px;
ย ย }
ย ย th {
ย ย ย ย background-color: #901090; /* Cor de destaque para o cabeรงalho */
ย ย ย ย color: white;
ย ย ย ย text-transform: uppercase;
ย ย ย ย letter-spacing: 0.8px;
ย ย ย ย font-weight: 700;
ย ย }
ย ยย
ย ย /* Linhas pares (cor de fundo mais clara) */
ย ย tr:nth-child(even) {
ย ย ย ย background-color: #f8f9fa;ย
ย ย }
ย ย /* Linhas รญmpares (cor de fundo branca) */
ย ย tr:nth-child(odd) {
ย ย ย ย background-color: white;ย
ย ย }

ย ย /* Efeito ao passar o mouse */
ย ย tr:hover {
ย ย ย ย background-color: #e2e6ea;
ย ย ย ย cursor: default;
ย ย ย ย transition: background-color 0.2s ease;
ย ย }

ย ย #loading {
ย ย ย ย font-size: 18px;
ย ย ย ย color: #cccccc; /* Ajustado para fundo escuro */
ย ย ย ย margin-top: 30px;
ย ย }
</style>
</head>
<body>

ย ย <div class="container">
ย ย ย ย <h1>Relatรณrio de Presenรงa Diรกria</h1>
ย ย ย ย <p>Dados brutos de todos os registros de presenรงa feitos via API. **(Acesso Admin)**</p>
		
		<div style="margin-bottom: 20px; text-align: right;">
ย ย		 <input type="text" id="searchInput" onkeyup="filterTable()"ย
ย ย ย ย ย ยplaceholder="Buscar por Nome ou CPF..."
ย ย ย ย ย ย>
		</div>
		
ย ย ย ย <div id="loading">Carregando dados da planilha...</div>

ย ย ย ย <table id="presencaTable" style="display: none;">
ย ย ย ย ย ย <thead>
ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย <th>Nome do Aluno</th>
ย ย ย ย ย ย ย ย ย ย <th>CPF do Aluno</th>
ย ย ย ย ย ย ย ย ย ย <th>Data do Registro</th>
ย ย ย ย ย ย ย ย ย ย <th>Hora do Registro</th>
ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย </thead>
ย ย ย ย ย ย <tbody id="presencaData">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tbody>
ย ย ย ย </table>

ย ย ย ย <p id="error" style="color: red; margin-top: 20px;"></p>
ย ย </div>

ย ย<script>
ย ย // ๐จ SEU URL CORRETO: (Mantenha o URL de Apps Script usado nas etapas anteriores)
ย ย const SHEETDB_API_URL = 'https://script.google.com/macros/s/AKfycbyZkAwC19qf7Lu5vT3lhS7QN03KJcr4weoU6NYLbbzcD17bbLiAh3C51vXoPvISeR40/exec';
ย ย // Aรงรฃo para buscar o log
ย ย const ADMIN_API_URL = `${SHEETDB_API_URL}?action=get_log_presenca`;

ย ย // ๐จ SEGURANรA: DEFINA UMA SENHA SECRETA AQUI!
ย ย const ADMIN_PASSWORD = 'AutoEscola2025';ย

ย ย // =======================================================
ย ย // NOVO: FUNรรO PARA CORRIGIR TIMESTAMP CORROMPIDO
ย ย // =======================================================

ย ย /**
ย ย ย* Corrige o formato corrompido de log (ex: 2025-12-02T...Z1899-12-30T...Z),ย
ย ย ย* separando a data da primeira parte e a hora da segunda.
ย ย ย* @param {string} corruptedString A string de data/hora corrompida.
ย ย ย* @returns {{date: string, time: string}} Um objeto com a data (DD/MM/YYYY) e hora (HH:MM:SS) corrigidas.
ย ย ย*/
ย ย function parseAndSplitCorruptedTimestamp(corruptedString) {
ย ย ย ย // Assume que strings menores que 30 caracteres nรฃo sรฃo o formato corrompido
ย ย ย ย if (typeof corruptedString !== 'string' || corruptedString.length < 30) {
ย ย ย ย ย ย return { date: corruptedString || 'N/A', time: 'N/A' };ย
ย ย ย ย }

ย ย ย ย // Procura o fim da primeira string ISO (onde termina .000Z)
ย ย ย ย const splitIndex = corruptedString.indexOf('.000Z');
ย ย ย ยย
ย ย ย ย // Se nรฃo encontrar o padrรฃo .000Z seguido por mais caracteres, retorna o original
ย ย ย ย if (splitIndex === -1 || splitIndex + 5 >= corruptedString.length) {
ย ย ย ย ย ย // Tentativa de retorno caso nรฃo seja o formato concatenado, mas ainda seja ISO
ย ย ย ย ย ย const datePart = corruptedString.substring(0, 10);
            const timePart = corruptedString.substring(11, 19);

            let dateStr = 'N/A';
            if (datePart.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const [year, month, day] = datePart.split('-');
                dateStr = `${day}/${month}/${year}`;
            }

ย ย ย ย ย ย return {ย
ย ย ย ย ย ย ย ย date: dateStr,
ย ย ย ย ย ย ย ย time: timePart || 'N/A' 
ย ย ย ย ย ย };ย
ย ย ย ย }
ย ย ย ยย
ย ย ย ย const datePartISO = corruptedString.substring(0, splitIndex + 5);ย
ย ย ย ย const timePartISO = corruptedString.substring(splitIndex + 5);ย
ย ย ย ยย
ย ย ย ย let dateStr = 'N/A';
ย ย ย ย let timeStr = 'N/A';
ย ย ย ยย
ย ย ย ย try {
ย ย ย ย ย ย // 1. Extrai a data (YYYY-MM-DD) da primeira parte (que tem a data correta)
ย ย ย ย ย ย const dateMatch = datePartISO.match(/^(\d{4}-\d{2}-\d{2})/);
ย ย ย ย ย ย if (dateMatch) {
ย ย ย ย ย ย ย ย // Converte para DD/MM/YYYY para o formato brasileiro
ย ย ย ย ย ย ย ย const [year, month, day] = dateMatch[1].split('-');
ย ย ย ย ย ย ย ย dateStr = `${day}/${month}/${year}`;
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย // 2. Extrai o tempo (HH:MM:SS) da segunda parte (que tem a hora correta)
ย ย ย ย ย ย const timeMatch = timePartISO.match(/T(\d{2}:\d{2}:\d{2})/);
ย ย ย ย ย ย if (timeMatch) {
ย ย ย ย ย ย ย ย timeStr = timeMatch[1]; // HH:MM:SS
ย ย ย ย ย ย }
ย ย ย ย } catch (e) {
ย ย ย ย ย ย console.error("Falha ao analisar o timestamp corrompido:", e);
ย ย ย ย }
ย ย ย ยย
ย ย ย ย return { date: dateStr, time: timeStr };ย
ย ย }

ย ย /**
ย ย ย* Checa o acesso do administrador com um prompt simples.
ย ย ย*/
ย ย function checkAdminAccess() {
ย ย ย ย const container = document.querySelector('.container');
ย ย ย ย // Remove a mensagem de carregamento inicial
ย ย ย ย document.getElementById('loading').style.display = 'none';

ย ย ย ย const password = prompt("๐ Por favor, digite a senha de administrador para acessar o relatรณrio:");

ย ย ย ย if (password === ADMIN_PASSWORD) {
ย ย ย ย ย ย container.style.display = 'block'; // Mostra o container
ย ย ย ย ย ย fetchPresencaData();
ย ย ย ย } else {
ย ย ย ย ย ย container.style.display = 'block';
ย ย ย ย ย ย container.innerHTML = '<h1>โ Acesso Negado</h1><p>Vocรช nรฃo tem permissรฃo para visualizar este relatรณrio.</p>';
ย ย ย ย }
ย ย }
ย ยย
ย ย /**
ย ย ย* Busca todos os dados da planilha de presenรงa e exibe-os em uma tabela.
ย ย ย*/
ย ย async function fetchPresencaData() {
ย ย ย ย const loading = document.getElementById('loading');
ย ย ย ย const table = document.getElementById('presencaTable');
ย ย ย ย const tbody = document.getElementById('presencaData');
ย ย ย ย const errorElement = document.getElementById('error');
ย ย ย ยย
ย ย ย ย loading.style.display = 'block';
ย ย ย ย table.style.display = 'none';
ย ย ย ย errorElement.textContent = '';
ย ย ย ย tbody.innerHTML = ''; // Limpa dados anteriores
ย ย ย ยย
ย ย ย ย try {
ย ย ย ย ย ย // 1. Faz uma requisiรงรฃo GET para buscar TODOS os dados do log
ย ย ย ย ย ย const response = await fetch(ADMIN_API_URL);
ย ย ย ย ย ยย
ย ย ย ย ย ย if (!response.ok) {
ย ย ย ย ย ย ย ย throw new Error(`Falha na API: Status ${response.status}`);
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย const data = await response.json();
ย ย ย ย ย ยย
ย ย ย ย ย ย if (!data || data.length === 0) {
ย ย ย ย ย ย ย ย errorElement.textContent = 'Nenhum registro de presenรงa encontrado na planilha.';
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย // 2. Itera sobre os dados e preenche a tabela
ย ย ย ย ย ย data.forEach(record => {
ย ย ย ย ย ย ย ย const row = tbody.insertRow();
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // =============================================================
ย ย ย ย ย ย ย ย // INรCIO: APLICAรรO DA CORREรรO DE FORMATO
ย ย ย ย ย ย ย ย // O campo que contem a data/hora corrompida deve ser ajustado aqui.
ย ย ย ย ย ย ย ย // =============================================================
ย ย ย ย ย ย ย ย let rawTimestamp = record.data_registro || record.hora_registro || ''; // Assumindo que pode estar em data_registro ou hora_registro
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย let dataFormatada = record.data_registro || 'N/A';
ย ย ย ย ย ย ย ย let horaFormatada = record.hora_registro || 'N/A';
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Se o timestamp for a string corrompida longa, corrige e separa
ย ย ย ย ย ย ย ย if (rawTimestamp.length > 30 && rawTimestamp.includes('.000Z1899-12-30T')) {
ย ย ย ย ย ย ย ย ย ย const corrected = parseAndSplitCorruptedTimestamp(rawTimestamp);
ย ย ย ย ย ย ย ย ย ย dataFormatada = corrected.date;
ย ย ย ย ย ย ย ย ย ย horaFormatada = corrected.time;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย // =============================================================
ย ย ย ย ย ย ย ย // FIM: APLICAรรO DA CORREรรO DE FORMATO
ย ย ย ย ย ย ย ย // =============================================================


ย ย ย ย ย ย ย ย // Adiciona um atributo de dados (data-search) para facilitar a busca
ย ย ย ย ย ย ย ย const searchableText = `${record.nome_aluno || ''} ${record.cpf || ''}`.toLowerCase();
ย ย ย ย ย ย ย ย row.setAttribute('data-search', searchableText);

ย ย ย ย ย ย ย ย // As chaves de objeto ('nome_aluno', 'cpf', etc.) vรชm do Apps Script
ย ย ย ย ย ย ย ย row.insertCell().textContent = record.nome_aluno || 'N/A';
ย ย ย ย ย ย ย ย row.insertCell().textContent = record.cpf || 'N/A';
ย ย ย ย ย ย ย ย // Usa a data e hora formatadas diretamente
ย ย ย ย ย ย ย ย row.insertCell().textContent = dataFormatada;
ย ย ย ย ย ย ย ย row.insertCell().textContent = horaFormatada;
ย ย ย ย ย ย });

ย ย ย ย ย ย // 3. Exibe a tabela
ย ย ย ย ย ย table.style.display = 'table';

ย ย ย ย } catch (error) {
ย ย ย ย ย ย console.error("Erro ao carregar relatรณrio:", error);
ย ย ย ย ย ย errorElement.textContent = `Erro ao carregar relatรณrio. Verifique a URL da API e a conexรฃo. Detalhes: ${error.message}`;
ย ย ย ย } finally {
ย ย ย ย ย ย loading.style.display = 'none';
ย ย ย ย }
ย ย }


ย ย /**
ย ย ย* Filtra a tabela em tempo real com base no texto digitado.
ย ย ย*/
ย ย function filterTable() {
ย ย ย ย // Pega o texto de busca e converte para minรบsculas
ย ย ย ย const input = document.getElementById('searchInput');
ย ย ย ย const filter = input.value.toLowerCase();
ย ย ย ยย
ย ย ย ย // Pega todas as linhas do corpo da tabela
ย ย ย ย const tbody = document.getElementById('presencaData');
ย ย ย ย const tr = tbody.getElementsByTagName('tr');

ย ย ย ย // Itera sobre as linhas
ย ย ย ย for (let i = 0; i < tr.length; i++) {
ย ย ย ย ย ย const row = tr[i];
ย ย ย ย ย ย // Pega o atributo data-search que criamos na funรงรฃo fetchPresencaData
ย ย ย ย ย ย const searchData = row.getAttribute('data-search');ย

ย ย ย ย ย ย if (searchData) {
ย ย ย ย ย ย ย ย // Se a linha contiver o texto de busca, exibe a linha
ย ย ย ย ย ย ย ย if (searchData.indexOf(filter) > -1) {
ย ย ย ย ย ย ย ย ย ย row.style.display = '';
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย // Caso contrรกrio, esconde a linha
ย ย ย ย ย ย ย ย ย ย row.style.display = 'none';
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }


ย ย // Inicia o cheque de acesso ao carregar a pรกgina
ย ย window.onload = checkAdminAccess;

</script>
</body>

</html>
