<script>
    const SHEETDB_API_URL = 'https://script.google.com/macros/s/AKfycbyZkAwC19qf7Lu5vT3lhS7QN03KJcr4weoU6NYLbbzcD17bbLiAh3C51vXoPvISeR40/exec';

    // Máscara de CPF automática
    document.getElementById('adminCpf').addEventListener('input', function(e) {
        let v = e.target.value.replace(/\D/g, "");
        v = v.replace(/(\d{3})(\d)/, "$1.$2");
        v = v.replace(/(\d{3})(\d)/, "$1.$2");
        v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
        e.target.value = v;
    });

    function handleLogin() {
        const cpf = document.getElementById('adminCpf').value;
        const key = document.getElementById('adminKey').value;
        const errorMsg = document.getElementById('loginError');

        if (!cpf || !key) {
            errorMsg.textContent = "Preencha todos os campos!";
            return;
        }

        // Esconde login e mostra container
        document.getElementById('adminLoginOverlay').style.display = 'none';
        document.querySelector('.container').style.display = 'block';
        fetchPresencaData(cpf, key);
    }

    async function fetchPresencaData(adminCpf, adminKey) {
        const loading = document.getElementById('loading');
        const table = document.getElementById('presencaTable');
        const tbody = document.getElementById('presencaData');
        const errorElement = document.getElementById('error');
        
        loading.style.display = 'block';
        table.style.display = 'none';
        tbody.innerHTML = ''; 

        // URL formatada para bater com o seu doGet(e)
        const url = `${SHEETDB_API_URL}?action=get_log_presenca&admin_cpf=${encodeURIComponent(adminCpf)}&admin_key=${encodeURIComponent(adminKey)}`;
        
        try {
            const response = await fetch(url);
            const responseData = await response.json();
            
            if (!responseData.success) {
                document.getElementById('adminLoginOverlay').style.display = 'flex';
                document.querySelector('.container').style.display = 'none';
                document.getElementById('loginError').textContent = responseData.message || "Acesso negado";
                return;
            }

            const data = responseData.data;
            if (!data || data.length === 0) {
                errorElement.textContent = 'Nenhum registro encontrado.';
                return;
            }
            
            data.forEach(record => {
                // CORREÇÃO: Criar a linha antes de inserir as células
                const row = tbody.insertRow();
                
                let dataRegistro = new Date(record.data_registro);
                let dataFormatada = "N/A";
                let horaFormatada = "N/A";

                if (!isNaN(dataRegistro.getTime())) {
                    dataFormatada = dataRegistro.toLocaleDateString('pt-BR');
                    horaFormatada = dataRegistro.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                }
                
                let cpfLimpo = String(record.cpf || '').replace(/\D/g, "");
                let cpfFormatado = cpfLimpo;
                if (cpfLimpo.length === 11) {
                    cpfFormatado = cpfLimpo.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
                }
                
                // Adiciona atributo de busca para o filtro funcionar
                row.setAttribute('data-search', `${record.nome_aluno} ${cpfLimpo}`.toLowerCase());
                
                row.insertCell().textContent = record.nome_aluno || 'N/A';
                row.insertCell().textContent = cpfFormatado || 'N/A';
                row.insertCell().textContent = dataFormatada;
                row.insertCell().textContent = horaFormatada;
            });

            table.style.display = 'table';
        } catch (error) {
            console.error(error);
            errorElement.textContent = "Erro de conexão ou falha ao processar dados.";
        } finally {
            loading.style.display = 'none';
        }
    }

    function filterTable() {
        const filter = document.getElementById('searchInput').value.toLowerCase();
        const tbody = document.getElementById('presencaData');
        const rows = tbody.getElementsByTagName('tr');
        
        for (let row of rows) {
            const txt = row.getAttribute('data-search') || "";
            row.style.display = txt.includes(filter) ? '' : 'none';
        }
    }
</script>
