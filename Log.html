<!DOCTYPE html>
<html lang="pt-BR">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>RelatÃ³rio de PresenÃ§a - ADMIN</title>
	<link rel="icon" type="image/x-icon" href="favicon.ico">
<style>
Â  Â  body {
Â  Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  Â  Â  background-color: #c1c1c1; /* Fundo ligeiramente mais claro */
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  .container {
Â  Â  Â  Â  max-width: 1000px;
Â  Â  Â  Â  margin: 20px auto;
Â  Â  Â  Â  background: black;
Â  Â  Â  Â  padding: 25px; /* Mais preenchimento */
Â  Â  Â  Â  border-radius: 12px; /* Cantos mais arredondados */
Â  Â  Â  Â  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15); /* Sombra mais destacada */
Â  Â  Â  Â  display: none;Â 
Â  Â  }
Â  Â  h1 {
Â  Â  Â  Â  color: #901090; /* Cor da tabela */
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  }
Â  Â  p {
Â  Â  Â  Â  color: #6c757d;
Â  Â  }
Â  Â Â 
Â  Â  /* --- Estilos da Tabela Melhorados --- */
Â  Â  table {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  border-collapse: collapse;
Â  Â  Â  Â  margin-top: 25px;
Â  Â  Â  Â  border-radius: 8px; /* Arredonda cantos da tabela */
Â  Â  Â  Â  overflow: hidden; /* Garante que os cantos arredondados sejam aplicados */
Â  Â  }
Â  Â  th, td {
Â  Â  Â  Â  border: none; /* Remove bordas internas para visual mais limpo */
Â  Â  Â  Â  padding: 15px 12px; /* Mais preenchimento */
Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  font-size: 15px; /* Fonte ligeiramente maior */
Â  Â  }
Â  Â  th {
Â  Â  Â  Â  background-color: #901090;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  letter-spacing: 0.5px;
Â  Â  Â  Â  font-weight: 700;
Â  Â  }
Â  Â Â 
Â  Â  /* Linhas pares (cor de fundo mais clara) */
Â  Â  tr:nth-child(even) {
Â  Â  Â  Â  background-color: #f8f9fa;Â 
Â  Â  }
Â  Â  /* Linhas Ã­mpares (cor de fundo branca) */
Â  Â  tr:nth-child(odd) {
Â  Â  Â  Â  background-color: white;Â 
Â  Â  }

Â  Â  /* Efeito ao passar o mouse: essencial para rastreamento */
Â  Â  tr:hover {
Â  Â  Â  Â  background-color: #e2e6ea; /* Um azul muito claro ao passar o mouse */
Â  Â  Â  Â  cursor: default;
Â  Â  Â  Â  transition: background-color 0.2s ease;
Â  Â  }

Â  Â  #loading {
Â  Â  Â  Â  font-size: 18px;
Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  margin-top: 30px;
Â  Â  }
</style>
</head>
<body>

Â  Â  <div class="container">
Â  Â  Â  Â  <h1>RelatÃ³rio de PresenÃ§a DiÃ¡ria</h1>
Â  Â  Â  Â  <p>Dados brutos de todos os registros de presenÃ§a feitos via API. **(Acesso Admin)**</p>
		
		<div style="margin-bottom: 20px; text-align: right;">
Â  Â 		 <input type="text" id="searchInput" onkeyup="filterTable()"Â 
Â  Â  Â  Â  Â  Â placeholder="Buscar por Nome ou CPF..."
Â  Â  Â  Â  Â  Â style="padding: 10px; width: 300px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;">
		</div>
		
Â  Â  Â  Â  <div id="loading">Carregando dados da planilha...</div>

Â  Â  Â  Â  <table id="presencaTable" style="display: none;">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Nome do Aluno</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>CPF do Aluno</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Data do Registro</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Hora do Registro</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="presencaData">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>

Â  Â  Â  Â  <p id="error" style="color: red; margin-top: 20px;"></p>
Â  Â  </div>

Â  Â <script>
Â  Â  // ğŸš¨ SEU URL CORRETO: (Mantenha o URL de Apps Script usado nas etapas anteriores)
Â  Â  const SHEETDB_API_URL = 'https://script.google.com/macros/s/AKfycbyZkAwC19qf7Lu5vT3lhS7QN03KJcr4weoU6NYLbbzcD17bbLiAh3C51vXoPvISeR40/exec';
Â  Â  // AÃ§Ã£o para buscar o log
Â  Â  const ADMIN_API_URL = `${SHEETDB_API_URL}?action=get_log_presenca`;

Â  Â  // ğŸš¨ SEGURANÃ‡A: DEFINA UMA SENHA SECRETA AQUI!
Â  Â  const ADMIN_PASSWORD = 'AutoEscola2025';Â 

Â  Â  // =======================================================
Â  Â  // NOVO: FUNÃ‡ÃƒO PARA CORRIGIR TIMESTAMP CORROMPIDO
Â  Â  // =======================================================

    /**
     * Corrige o formato corrompido de log (ex: 2025-12-02T...Z1899-12-30T...Z), 
     * separando a data da primeira parte e a hora da segunda.
     * @param {string} corruptedString A string de data/hora corrompida.
     * @returns {{date: string, time: string}} Um objeto com a data (DD/MM/YYYY) e hora (HH:MM:SS) corrigidas.
     */
    function parseAndSplitCorruptedTimestamp(corruptedString) {
        // Assume que strings menores que 30 caracteres nÃ£o sÃ£o o formato corrompido
        if (typeof corruptedString !== 'string' || corruptedString.length < 30) {
            return { date: corruptedString || 'N/A', time: 'N/A' }; 
        }

        // Procura o fim da primeira string ISO (onde termina .000Z)
        const splitIndex = corruptedString.indexOf('.000Z');
        
        // Se nÃ£o encontrar o padrÃ£o .000Z seguido por mais caracteres, retorna o original
        if (splitIndex === -1 || splitIndex + 5 >= corruptedString.length) {
            return { 
                date: corruptedString.substring(0, 10) || 'N/A', // Tenta pegar a data YYYY-MM-DD
                time: corruptedString.substring(11, 19) || 'N/A' // Tenta pegar a hora HH:MM:SS
            }; 
        }
        
        const datePartISO = corruptedString.substring(0, splitIndex + 5); 
        const timePartISO = corruptedString.substring(splitIndex + 5); 
        
        let dateStr = 'N/A';
        let timeStr = 'N/A';
        
        try {
            // 1. Extrai a data (YYYY-MM-DD) da primeira parte (que tem a data correta)
            const dateMatch = datePartISO.match(/^(\d{4}-\d{2}-\d{2})/);
            if (dateMatch) {
                // Converte para DD/MM/YYYY para o formato brasileiro
                const [year, month, day] = dateMatch[1].split('-');
                dateStr = `${day}/${month}/${year}`;
            }
            
            // 2. Extrai o tempo (HH:MM:SS) da segunda parte (que tem a hora correta)
            const timeMatch = timePartISO.match(/T(\d{2}:\d{2}:\d{2})/);
            if (timeMatch) {
                timeStr = timeMatch[1]; // HH:MM:SS
            }
        } catch (e) {
            console.error("Falha ao analisar o timestamp corrompido:", e);
        }
        
        return { date: dateStr, time: timeStr }; 
    }

Â  Â  /**
Â  Â  Â * Checa o acesso do administrador com um prompt simples.
Â  Â  Â */
Â  Â  function checkAdminAccess() {
Â  Â  Â  Â  const container = document.querySelector('.container');
Â  Â  Â  Â  // Remove a mensagem de carregamento inicial
Â  Â  Â  Â  document.getElementById('loading').style.display = 'none';

Â  Â  Â  Â  const password = prompt("ğŸ” Por favor, digite a senha de administrador para acessar o relatÃ³rio:");

Â  Â  Â  Â  if (password === ADMIN_PASSWORD) {
Â  Â  Â  Â  Â  Â  container.style.display = 'block'; // Mostra o container
Â  Â  Â  Â  Â  Â  fetchPresencaData();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  container.style.display = 'block';
Â  Â  Â  Â  Â  Â  container.innerHTML = '<h1>âŒ Acesso Negado</h1><p>VocÃª nÃ£o tem permissÃ£o para visualizar este relatÃ³rio.</p>';
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  /**
Â  Â  Â * Busca todos os dados da planilha de presenÃ§a e exibe-os em uma tabela.
Â  Â  Â * (CORRIGIDO para usar a funÃ§Ã£o de parser)
Â  Â  Â */
Â  Â  async function fetchPresencaData() {
Â  Â  Â  Â  const loading = document.getElementById('loading');
Â  Â  Â  Â  const table = document.getElementById('presencaTable');
Â  Â  Â  Â  const tbody = document.getElementById('presencaData');
Â  Â  Â  Â  const errorElement = document.getElementById('error');
Â  Â  Â  Â Â 
Â  Â  Â  Â  loading.style.display = 'block';
Â  Â  Â  Â  table.style.display = 'none';
Â  Â  Â  Â  errorElement.textContent = '';
Â  Â  Â  Â  tbody.innerHTML = ''; // Limpa dados anteriores
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // 1. Faz uma requisiÃ§Ã£o GET para buscar TODOS os dados do log
Â  Â  Â  Â  Â  Â  const response = await fetch(ADMIN_API_URL);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Falha na API: Status ${response.status}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!data || data.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  errorElement.textContent = 'Nenhum registro de presenÃ§a encontrado na planilha.';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. Itera sobre os dados e preenche a tabela
Â  Â  Â  Â  Â  Â  data.forEach(record => {
Â  Â  Â  Â  Â  Â  Â  Â  const row = tbody.insertRow();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // =============================================================
Â  Â  Â  Â  Â  Â  Â  Â  // INÃCIO: APLICAÃ‡ÃƒO DA CORREÃ‡ÃƒO DE FORMATO
Â  Â  Â  Â  Â  Â  Â  Â  // Assume que o campo que contÃ©m o timestamp corrompido Ã© o data_registro
Â  Â  Â  Â  Â  Â  Â  Â  // Se o campo for o hora_registro, ajuste a linha abaixo.
Â  Â  Â  Â  Â  Â  Â  Â  // =============================================================
Â  Â  Â  Â  Â  Â  Â  Â  let dataFormatada = record.data_registro || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  let horaFormatada = record.hora_registro || 'N/A';
                
                // Se a data do registro parece ser uma string ISO longa e corrompida
                if (dataFormatada.length > 30 && dataFormatada.indexOf('.000Z') > 10) {
                    const corrected = parseAndSplitCorruptedTimestamp(dataFormatada);
                    dataFormatada = corrected.date;
                    horaFormatada = corrected.time;
                }
Â  Â  Â  Â  Â  Â  Â  Â  // =============================================================
Â  Â  Â  Â  Â  Â  Â  Â  // FIM: APLICAÃ‡ÃƒO DA CORREÃ‡ÃƒO DE FORMATO
Â  Â  Â  Â  Â  Â  Â  Â  // =============================================================


Â  Â  Â  Â  Â  Â  Â  Â  // Adiciona um atributo de dados (data-search) para facilitar a busca
Â  Â  Â  Â  Â  Â  Â  Â  const searchableText = `${record.nome_aluno || ''} ${record.cpf || ''}`.toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  row.setAttribute('data-search', searchableText);

Â  Â  Â  Â  Â  Â  Â  Â  // As chaves de objeto ('nome_aluno', 'cpf', etc.) vÃªm do Apps Script
Â  Â  Â  Â  Â  Â  Â  Â  row.insertCell().textContent = record.nome_aluno || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  row.insertCell().textContent = record.cpf || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  // Usa a data e hora formatadas diretamente
Â  Â  Â  Â  Â  Â  Â  Â  row.insertCell().textContent = dataFormatada;
Â  Â  Â  Â  Â  Â  Â  Â  row.insertCell().textContent = horaFormatada;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 3. Exibe a tabela
Â  Â  Â  Â  Â  Â  table.style.display = 'table';

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Erro ao carregar relatÃ³rio:", error);
Â  Â  Â  Â  Â  Â  errorElement.textContent = `Erro ao carregar relatÃ³rio. Verifique a URL da API e a conexÃ£o. Detalhes: ${error.message}`;
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  loading.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  }


Â  Â  /**
Â  Â  Â * Filtra a tabela em tempo real com base no texto digitado.
Â  Â  Â */
Â  Â  function filterTable() {
Â  Â  Â  Â  // Pega o texto de busca e converte para minÃºsculas
Â  Â  Â  Â  const input = document.getElementById('searchInput');
Â  Â  Â  Â  const filter = input.value.toLowerCase();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Pega todas as linhas do corpo da tabela
Â  Â  Â  Â  const tbody = document.getElementById('presencaData');
Â  Â  Â  Â  const tr = tbody.getElementsByTagName('tr');

Â  Â  Â  Â  // Itera sobre as linhas
Â  Â  Â  Â  for (let i = 0; i < tr.length; i++) {
Â  Â  Â  Â  Â  Â  const row = tr[i];
Â  Â  Â  Â  Â  Â  // Pega o atributo data-search que criamos na funÃ§Ã£o fetchPresencaData
Â  Â  Â  Â  Â  Â  const searchData = row.getAttribute('data-search');Â 

Â  Â  Â  Â  Â  Â  if (searchData) {
Â  Â  Â  Â  Â  Â  Â  Â  // Se a linha contiver o texto de busca, exibe a linha
Â  Â  Â  Â  Â  Â  Â  Â  if (searchData.indexOf(filter) > -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.style.display = '';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Caso contrÃ¡rio, esconde a linha
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }


Â  Â  // Inicia o cheque de acesso ao carregar a pÃ¡gina
Â  Â  window.onload = checkAdminAccess;

</script>
</body>

</html>
